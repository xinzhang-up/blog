<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[案例]智能体session设计 | 信长笔记2.0</title>
    <meta name="description" content="信长笔记2.0">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/blog/assets/style.D9H2We2F.css" as="style">
    <link rel="preload stylesheet" href="/blog/vp-icons.css" as="style">
    
    <script type="module" src="/blog/assets/app.BfEPfjb7.js"></script>
    <link rel="preload" href="/blog/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/blog/assets/chunks/theme.Dmldpq0m.js">
    <link rel="modulepreload" href="/blog/assets/chunks/framework.CP8pidWN.js">
    <link rel="modulepreload" href="/blog/assets/04-缓存与中间件_0403-Redis_040301-_案例_智能体session设计.md.B8Xd3FbF.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-a9a9e638><!--[--><!--]--><!--[--><span tabindex="-1" data-v-492508fc></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-492508fc>Skip to content</a><!--]--><!----><header class="VPNav" data-v-a9a9e638 data-v-f1e365da><div class="VPNavBar" data-v-f1e365da data-v-822684d1><div class="wrapper" data-v-822684d1><div class="container" data-v-822684d1><div class="title" data-v-822684d1><div class="VPNavBarTitle has-sidebar" data-v-822684d1 data-v-0f4f798b><a class="title" href="/blog/" data-v-0f4f798b><!--[--><!--]--><!--[--><img class="VPImage logo" src="/blog/avatar.jpg" alt data-v-35a7d0b8><!--]--><span data-v-0f4f798b>信长笔记2.0</span><!--[--><!--]--></a></div></div><div class="content" data-v-822684d1><div class="content-body" data-v-822684d1><!--[--><!--]--><div class="VPNavBarSearch search" data-v-822684d1><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-822684d1 data-v-e6d46098><span id="main-nav-aria-label" class="visually-hidden" data-v-e6d46098> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/" tabindex="0" data-v-e6d46098 data-v-956ec74c><!--[--><span data-v-956ec74c>首页</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/blog/%E5%85%B3%E4%BA%8E%E6%88%91.html" tabindex="0" data-v-e6d46098 data-v-956ec74c><!--[--><span data-v-956ec74c>关于我</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-822684d1 data-v-af096f4a><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-af096f4a data-v-e40a8bb6 data-v-4a1c76db><span class="check" data-v-4a1c76db><span class="icon" data-v-4a1c76db><!--[--><span class="vpi-sun sun" data-v-e40a8bb6></span><span class="vpi-moon moon" data-v-e40a8bb6></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-822684d1 data-v-164c457f data-v-ee7a9424><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/vitepress" aria-label="github" target="_blank" rel="noopener" data-v-ee7a9424 data-v-d26d30cb><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-822684d1 data-v-925effce data-v-04f5c5e9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-04f5c5e9><span class="vpi-more-horizontal icon" data-v-04f5c5e9></span></button><div class="menu" data-v-04f5c5e9><div class="VPMenu" data-v-04f5c5e9 data-v-7dd3104a><!----><!--[--><!--[--><!----><div class="group" data-v-925effce><div class="item appearance" data-v-925effce><p class="label" data-v-925effce>Appearance</p><div class="appearance-action" data-v-925effce><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-925effce data-v-e40a8bb6 data-v-4a1c76db><span class="check" data-v-4a1c76db><span class="icon" data-v-4a1c76db><!--[--><span class="vpi-sun sun" data-v-e40a8bb6></span><span class="vpi-moon moon" data-v-e40a8bb6></span><!--]--></span></span></button></div></div></div><div class="group" data-v-925effce><div class="item social-links" data-v-925effce><div class="VPSocialLinks social-links-list" data-v-925effce data-v-ee7a9424><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/vitepress" aria-label="github" target="_blank" rel="noopener" data-v-ee7a9424 data-v-d26d30cb><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-822684d1 data-v-5dea55bf><span class="container" data-v-5dea55bf><span class="top" data-v-5dea55bf></span><span class="middle" data-v-5dea55bf></span><span class="bottom" data-v-5dea55bf></span></span></button></div></div></div></div><div class="divider" data-v-822684d1><div class="divider-line" data-v-822684d1></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-a9a9e638 data-v-070ab83d><div class="container" data-v-070ab83d><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-070ab83d><span class="vpi-align-left menu-icon" data-v-070ab83d></span><span class="menu-text" data-v-070ab83d>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-070ab83d data-v-168ddf5d><button data-v-168ddf5d>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-a9a9e638 data-v-18756405><div class="curtain" data-v-18756405></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-18756405><span class="visually-hidden" id="sidebar-aria-label" data-v-18756405> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-9e426adc><div class="VPSidebarItem level-0" data-v-9e426adc data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><p class="text" data-v-a4b0d9bf>计算机基础</p><!----></div><!----></div></div><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0" data-v-9e426adc data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h2 class="text" data-v-a4b0d9bf>Java语言基础</h2><!----></div><div class="items" data-v-a4b0d9bf><!--[--><section class="VPSidebarItem level-1 collapsible collapsed" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h3 class="text" data-v-a4b0d9bf>Java核心知识点</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-a4b0d9bf><span class="vpi-chevron-right caret-icon" data-v-a4b0d9bf></span></div></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/02-Java%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/0201-Java%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9/020101-Java%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>Java语言基础</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/02-Java%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/0201-Java%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9/020102-IO%E6%A8%A1%E5%9E%8B.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>IO模型</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/02-Java%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/0201-Java%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86%E7%82%B9/020103-%E9%9B%86%E5%90%88.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>集合</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible collapsed" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h3 class="text" data-v-a4b0d9bf>JVM</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-a4b0d9bf><span class="vpi-chevron-right caret-icon" data-v-a4b0d9bf></span></div></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/02-Java%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/0203-JVM/020301-JVM%E5%9F%BA%E7%A1%80.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>JVM基础</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0" data-v-9e426adc data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h2 class="text" data-v-a4b0d9bf>数据库与持久化</h2><!----></div><div class="items" data-v-a4b0d9bf><!--[--><section class="VPSidebarItem level-1 collapsible collapsed" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h3 class="text" data-v-a4b0d9bf>关系型数据库</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-a4b0d9bf><span class="vpi-chevron-right caret-icon" data-v-a4b0d9bf></span></div></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/03-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96/0301-%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/030101-PowerDesign%E7%AE%80%E6%98%93%E6%95%99%E7%A8%8B.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>PowerDesign简易教程</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/03-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96/0301-%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/030102-%E7%B4%A2%E5%BC%95.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>索引</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/03-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96/0301-%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/030103-MySQL%E5%9F%BA%E7%A1%80.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>MySQL基础</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0 has-active" data-v-9e426adc data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h2 class="text" data-v-a4b0d9bf>缓存与中间件</h2><!----></div><div class="items" data-v-a4b0d9bf><!--[--><section class="VPSidebarItem level-1 collapsible collapsed" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h3 class="text" data-v-a4b0d9bf>RabbitMQ</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-a4b0d9bf><span class="vpi-chevron-right caret-icon" data-v-a4b0d9bf></span></div></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/04-%E7%BC%93%E5%AD%98%E4%B8%8E%E4%B8%AD%E9%97%B4%E4%BB%B6/0401-RabbitMQ/040101-RabbitMQ%E5%9F%BA%E7%A1%80(%E4%B8%80).html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>RabbitMQ基础(一)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/04-%E7%BC%93%E5%AD%98%E4%B8%8E%E4%B8%AD%E9%97%B4%E4%BB%B6/0401-RabbitMQ/040102-RabbitMQ%E5%9F%BA%E7%A1%80(%E4%BA%8C).html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>RabbitMQ基础(二)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/04-%E7%BC%93%E5%AD%98%E4%B8%8E%E4%B8%AD%E9%97%B4%E4%BB%B6/0401-RabbitMQ/040103-RabbitMQ%E5%AE%9E%E8%B7%B5.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>RabbitMQ实践</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible collapsed" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h3 class="text" data-v-a4b0d9bf>RocketMQ</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-a4b0d9bf><span class="vpi-chevron-right caret-icon" data-v-a4b0d9bf></span></div></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/04-%E7%BC%93%E5%AD%98%E4%B8%8E%E4%B8%AD%E9%97%B4%E4%BB%B6/0402-RocketMQ/040201-RockectMQ%E5%9F%BA%E7%A1%80.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>RockectMQ基础</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible collapsed has-active" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h3 class="text" data-v-a4b0d9bf>Redis</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-a4b0d9bf><span class="vpi-chevron-right caret-icon" data-v-a4b0d9bf></span></div></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/04-%E7%BC%93%E5%AD%98%E4%B8%8E%E4%B8%AD%E9%97%B4%E4%BB%B6/0403-Redis/040301-[%E6%A1%88%E4%BE%8B]%E6%99%BA%E8%83%BD%E4%BD%93session%E8%AE%BE%E8%AE%A1.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>[案例]智能体session设计</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0" data-v-9e426adc data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h2 class="text" data-v-a4b0d9bf>微服务与分布式系统</h2><!----></div><div class="items" data-v-a4b0d9bf><!--[--><section class="VPSidebarItem level-1 collapsible collapsed" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h3 class="text" data-v-a4b0d9bf>微服务</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-a4b0d9bf><span class="vpi-chevron-right caret-icon" data-v-a4b0d9bf></span></div></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/05-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/0501-%E5%BE%AE%E6%9C%8D%E5%8A%A1/050101-RateLimiter.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>RateLimiter</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/05-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/0501-%E5%BE%AE%E6%9C%8D%E5%8A%A1/050102-Filter&amp;Interceptor&amp;Aspect%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>Filter&Interceptor&Aspect使用场景</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible collapsed" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h3 class="text" data-v-a4b0d9bf>分布式</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-a4b0d9bf><span class="vpi-chevron-right caret-icon" data-v-a4b0d9bf></span></div></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/05-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/0502-%E5%88%86%E5%B8%83%E5%BC%8F/050201-%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>分布式理论</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/05-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/0502-%E5%88%86%E5%B8%83%E5%BC%8F/050202-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>服务注册与发现</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/05-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/0502-%E5%88%86%E5%B8%83%E5%BC%8F/050203-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>客户端负载均衡</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/05-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/0502-%E5%88%86%E5%B8%83%E5%BC%8F/050204-%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99%E4%BF%9D%E6%8A%A4.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>服务容错保护</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/05-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/0502-%E5%88%86%E5%B8%83%E5%BC%8F/050205-%E5%A3%B0%E6%98%8E%E5%BC%8F%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>声明式服务调用</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/05-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/0502-%E5%88%86%E5%B8%83%E5%BC%8F/050206-API%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>API网关服务</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/05-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/0502-%E5%88%86%E5%B8%83%E5%BC%8F/050207-%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>分布式配置中心</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/05-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/0502-%E5%88%86%E5%B8%83%E5%BC%8F/050208-%E5%88%86%E5%B8%83%E5%BC%8F%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>分布式链路追踪</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/05-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/0502-%E5%88%86%E5%B8%83%E5%BC%8F/050209-%E9%98%BF%E9%87%8C%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E6%8A%80%E6%9C%AF%E7%99%BD%E7%9A%AE%E4%B9%A6.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>阿里微服务治理技术白皮书</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0" data-v-9e426adc data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h2 class="text" data-v-a4b0d9bf>架构设计与开发规范</h2><!----></div><div class="items" data-v-a4b0d9bf><!--[--><section class="VPSidebarItem level-1 collapsible collapsed" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h3 class="text" data-v-a4b0d9bf>设计模式</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-a4b0d9bf><span class="vpi-chevron-right caret-icon" data-v-a4b0d9bf></span></div></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/06-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/0601-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/060101-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E4%B8%8E%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>面向对象与设计原则</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/06-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/0601-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/060102-%E8%A7%84%E8%8C%83%E4%B8%8E%E9%87%8D%E6%9E%84.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>规范与重构</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/06-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/0601-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/060103-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%88%9B%E5%BB%BA%E5%9E%8B.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>设计模式-创建型</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/06-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/0601-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/060104-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E7%BB%93%E6%9E%84%E5%9E%8B.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>设计模式-结构型</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/06-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/0601-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/060105-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A1%8C%E4%B8%BA%E5%9E%8B(%E4%B8%8A).html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>设计模式-行为型(上)</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/06-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/0601-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/060106-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A1%8C%E4%B8%BA%E5%9E%8B(%E4%B8%8B).html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>设计模式-行为型(下)</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible collapsed" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h3 class="text" data-v-a4b0d9bf>业务建模</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-a4b0d9bf><span class="vpi-chevron-right caret-icon" data-v-a4b0d9bf></span></div></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/06-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/0603-%E4%B8%9A%E5%8A%A1%E5%BB%BA%E6%A8%A1/060301-%E4%B8%9A%E5%8A%A1%E5%BB%BA%E6%A8%A1%E5%9F%BA%E7%A1%80.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>业务建模基础</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><div class="no-transition group" data-v-9e426adc><div class="VPSidebarItem level-0" data-v-9e426adc data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><p class="text" data-v-a4b0d9bf>开发工具与DevOps</p><!----></div><!----></div></div><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0" data-v-9e426adc data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h2 class="text" data-v-a4b0d9bf>前沿技术与扩展领域</h2><!----></div><div class="items" data-v-a4b0d9bf><!--[--><section class="VPSidebarItem level-1 collapsible collapsed" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h3 class="text" data-v-a4b0d9bf>人工智能</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-a4b0d9bf><span class="vpi-chevron-right caret-icon" data-v-a4b0d9bf></span></div></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/08-%E5%89%8D%E6%B2%BF%E6%8A%80%E6%9C%AF%E4%B8%8E%E6%89%A9%E5%B1%95%E9%A2%86%E5%9F%9F/0801-%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/080101-GPT%E5%8E%9F%E7%90%86.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>GPT原理</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/08-%E5%89%8D%E6%B2%BF%E6%8A%80%E6%9C%AF%E4%B8%8E%E6%89%A9%E5%B1%95%E9%A2%86%E5%9F%9F/0801-%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/080102-RAG%E4%BC%98%E5%8C%96.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>RAG优化</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0" data-v-9e426adc data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h2 class="text" data-v-a4b0d9bf>实战与问题排查</h2><!----></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-1 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/09-%E5%AE%9E%E6%88%98%E4%B8%8E%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/0901-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E7%83%AD%E5%88%B7%E5%90%8E%E6%97%A0%E6%B3%95%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E9%97%AE%E9%A2%98.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>微服务配置热刷后无法处理请求问题</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/09-%E5%AE%9E%E6%88%98%E4%B8%8E%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/0902-%E4%BF%A1%E9%95%BF%E5%8D%9A%E5%AE%A2%E7%AB%99%E6%90%AD%E5%BB%BA.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>信长博客站搭建</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0" data-v-9e426adc data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h2 class="text" data-v-a4b0d9bf>其他</h2><!----></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-1 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><!----><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><!----><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-9e426adc><section class="VPSidebarItem level-0" data-v-9e426adc data-v-a4b0d9bf><div class="item" role="button" tabindex="0" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><h2 class="text" data-v-a4b0d9bf>杂学</h2><!----></div><div class="items" data-v-a4b0d9bf><!--[--><div class="VPSidebarItem level-1 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/11-%E6%9D%82%E5%AD%A6/1101-%E7%BE%BD%E6%AF%9B%E7%90%83%E7%BB%83%E4%B9%A0%E5%BF%83%E5%BE%97.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>羽毛球练习心得</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/11-%E6%9D%82%E5%AD%A6/1102-%E8%8A%AF%E7%89%87.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>芯片</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/11-%E6%9D%82%E5%AD%A6/1103-%E4%BF%A1%E9%95%BF%E5%8E%A8%E6%88%BF.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>信长厨房</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-a4b0d9bf data-v-a4b0d9bf><div class="item" data-v-a4b0d9bf><div class="indicator" data-v-a4b0d9bf></div><a class="VPLink link link" href="/blog/11-%E6%9D%82%E5%AD%A6/1104-%E4%BF%A1%E9%95%BF%E7%9A%84%E8%87%B3%E7%90%86%E5%90%8D%E8%A8%80.html" data-v-a4b0d9bf><!--[--><p class="text" data-v-a4b0d9bf>信长的至理名言</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-9e426adc><div class="VPSidebarItem level-0" data-v-9e426adc data-v-a4b0d9bf><!----><!----></div></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-a9a9e638 data-v-91765379><div class="VPDoc has-sidebar has-aside" data-v-91765379 data-v-83890dd9><!--[--><!--]--><div class="container" data-v-83890dd9><div class="aside" data-v-83890dd9><div class="aside-curtain" data-v-83890dd9></div><div class="aside-container" data-v-83890dd9><div class="aside-content" data-v-83890dd9><div class="VPDocAside" data-v-83890dd9 data-v-6d7b3c46><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-6d7b3c46 data-v-b38bf2ff><div class="content" data-v-b38bf2ff><div class="outline-marker" data-v-b38bf2ff></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-b38bf2ff>On this page</div><ul class="VPDocOutlineItem root" data-v-b38bf2ff data-v-3f927ebe><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-6d7b3c46></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-83890dd9><div class="content-container" data-v-83890dd9><!--[--><!--]--><main class="main" data-v-83890dd9><div style="position:relative;" class="vp-doc _blog_04-%E7%BC%93%E5%AD%98%E4%B8%8E%E4%B8%AD%E9%97%B4%E4%BB%B6_0403-Redis_040301-[%E6%A1%88%E4%BE%8B]%E6%99%BA%E8%83%BD%E4%BD%93session%E8%AE%BE%E8%AE%A1" data-v-83890dd9><div><h1 id="案例-智能体session设计" tabindex="-1">[案例]智能体session设计 <a class="header-anchor" href="#案例-智能体session设计" aria-label="Permalink to &quot;[案例]智能体session设计&quot;">​</a></h1><h2 id="要求-设计智能体的session-要求保留最近7天的消息-总消息长度不超过10000字符-超过了则舍弃最早的消息-需要考虑线程安全" tabindex="-1">要求：设计智能体的session，要求保留最近7天的消息，总消息长度不超过10000字符，超过了则舍弃最早的消息，需要考虑线程安全 <a class="header-anchor" href="#要求-设计智能体的session-要求保留最近7天的消息-总消息长度不超过10000字符-超过了则舍弃最早的消息-需要考虑线程安全" aria-label="Permalink to &quot;要求：设计智能体的session，要求保留最近7天的消息，总消息长度不超过10000字符，超过了则舍弃最早的消息，需要考虑线程安全&quot;">​</a></h2><p>Prompt</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>你是一个AI智能体应用领域的 java技术专家, 现需要解决以下技术问题:</span></span>
<span class="line"><span>在用户与智能体交互过程中, 请设计一个session机制以记录历史对话实现多轮对话, 该机制需满足以下要求:</span></span>
<span class="line"><span>1. 消息格式为:{&quot;role&quot;:&quot;user/assistant&quot;,&quot;content&quot;:&quot;123&quot;}</span></span>
<span class="line"><span>2. 由于大模型token限制, 历史消息最多记录1w字符, 超出则舍弃最早的历史消息</span></span>
<span class="line"><span>3. 使用redis作为消息存储, 以用户id-群聊id(umId-groupId), 作为缓存key</span></span>
<span class="line"><span>4. 最多只保存最近7天内的历史消息</span></span>
<span class="line"><span>5. 设计一个SessionManager, 在对话开始时查询历史消息记录并加入到当前对话, 对话结束时保存当前对话到历史消息记录中</span></span>
<span class="line"><span>6. 需要给出代码实现, 性能越快越好, 并且需要考虑高并发下的线程安全</span></span>
<span class="line"><span>7. 请用RedisTemplate操作Redis</span></span></code></pre></div><h2 id="实现1-0-zset-redis事务" tabindex="-1">实现1.0: zset+redis事务 <a class="header-anchor" href="#实现1-0-zset-redis事务" aria-label="Permalink to &quot;实现1.0: zset+redis事务&quot;">​</a></h2><p>SessionManager</p><ul><li>使用zset来保存消息集合, 按照时间戳作为分数排序, 可以便捷按照范围查询以及删除</li><li>使用redis事务, 在保存历史消息时, 删除过期消息以及超过字符的消息</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span></span></span>
<span class="line"><span>import org.springframework.data.redis.core.RedisTemplate;</span></span>
<span class="line"><span>import org.springframework.data.redis.core.ZSetOperations;</span></span>
<span class="line"><span>import org.springframework.stereotype.Component;</span></span>
<span class="line"><span>import com.alibaba.fastjson.JSON;</span></span>
<span class="line"><span>import com.alibaba.fastjson.JSONObject;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import javax.annotation.Resource;</span></span>
<span class="line"><span>import java.util.ArrayList;</span></span>
<span class="line"><span>import java.util.List;</span></span>
<span class="line"><span>import java.util.Set;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@Component</span></span>
<span class="line"><span>public class SessionManager {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    private static final int MAX_HISTORY_LENGTH = 10000; // 历史消息最大长度（字符数）</span></span>
<span class="line"><span>    private static final int HISTORY_EXPIRE_DAYS = 7; // 历史消息有效期（天）</span></span>
<span class="line"><span>    private static final long HISTORY_EXPIRE_SECONDS = HISTORY_EXPIRE_DAYS * 24 * 60 * 60; // 转换为秒</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Resource</span></span>
<span class="line"><span>    private RedisTemplate&lt;String, String&gt; redisTemplate; // RedisTemplate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 获取历史消息</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     * @param umId    用户ID</span></span>
<span class="line"><span>     * @param groupId 群聊ID</span></span>
<span class="line"><span>     * @return 历史消息列表</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    public List&lt;JSONObject&gt; getHistory(String umId, String groupId) {</span></span>
<span class="line"><span>        String key = generateKey(umId, groupId);</span></span>
<span class="line"><span>        // 获取最近7天的消息</span></span>
<span class="line"><span>        long minScore = System.currentTimeMillis() / 1000 - HISTORY_EXPIRE_SECONDS;</span></span>
<span class="line"><span>        Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; messages = redisTemplate.opsForZSet().rangeByScoreWithScores(key, minScore, Double.POSITIVE_INFINITY);</span></span>
<span class="line"><span>        List&lt;JSONObject&gt; history = new ArrayList&lt;&gt;();</span></span>
<span class="line"><span>        if (messages != null) {</span></span>
<span class="line"><span>            for (ZSetOperations.TypedTuple&lt;String&gt; message : messages) {</span></span>
<span class="line"><span>                history.add(JSON.parseObject(message.getValue()));</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        return history;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 保存当前对话到历史消息</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     * @param umId     用户ID</span></span>
<span class="line"><span>     * @param groupId  群聊ID</span></span>
<span class="line"><span>     * @param messages 当前对话消息列表</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    public void saveHistory(String umId, String groupId, List&lt;JSONObject&gt; messages) {</span></span>
<span class="line"><span>        String key = generateKey(umId, groupId);</span></span>
<span class="line"><span>        // 开启事务</span></span>
<span class="line"><span>        redisTemplate.setEnableTransactionSupport(true);</span></span>
<span class="line"><span>        redisTemplate.multi();</span></span>
<span class="line"><span>        try {</span></span>
<span class="line"><span>            // 添加新消息</span></span>
<span class="line"><span>            long currentTime = System.currentTimeMillis() / 1000;</span></span>
<span class="line"><span>            for (JSONObject message : messages) {</span></span>
<span class="line"><span>                redisTemplate.opsForZSet().add(key, message.toJSONString(), currentTime);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            // 删除7天前的消息</span></span>
<span class="line"><span>            long minScore = currentTime - HISTORY_EXPIRE_SECONDS;</span></span>
<span class="line"><span>            redisTemplate.opsForZSet().removeRangeByScore(key, 0, minScore);</span></span>
<span class="line"><span>            // 检查历史消息总字符数，超出则移除最早的消息</span></span>
<span class="line"><span>            trimHistoryByLength(key);</span></span>
<span class="line"><span>            // 提交事务</span></span>
<span class="line"><span>            redisTemplate.exec();</span></span>
<span class="line"><span>        } catch (Exception e) {</span></span>
<span class="line"><span>            e.printStackTrace();</span></span>
<span class="line"><span>            redisTemplate.discard();</span></span>
<span class="line"><span>        } finally {</span></span>
<span class="line"><span>            redisTemplate.setEnableTransactionSupport(false);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 根据消息总字符数修剪历史消息</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     * @param key Redis Key</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    private void trimHistoryByLength(String key) {</span></span>
<span class="line"><span>        // 获取所有消息</span></span>
<span class="line"><span>        Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; messages = redisTemplate.opsForZSet().rangeWithScores(key, 0, -1);</span></span>
<span class="line"><span>        if (messages == null || messages.isEmpty()) {</span></span>
<span class="line"><span>            return;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        // 计算总字符数</span></span>
<span class="line"><span>        int totalLength = 0;</span></span>
<span class="line"><span>        for (ZSetOperations.TypedTuple&lt;String&gt; message : messages) {</span></span>
<span class="line"><span>            totalLength += message.getValue().length();</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        // 如果总字符数超过限制，删除最早的消息</span></span>
<span class="line"><span>        while (totalLength &gt; MAX_HISTORY_LENGTH &amp;&amp; !messages.isEmpty()) {</span></span>
<span class="line"><span>            ZSetOperations.TypedTuple&lt;String&gt; oldestMessage = messages.iterator().next();</span></span>
<span class="line"><span>            redisTemplate.opsForZSet().remove(key, oldestMessage.getValue());</span></span>
<span class="line"><span>            totalLength -= oldestMessage.getValue().length();</span></span>
<span class="line"><span>            messages = redisTemplate.opsForZSet().rangeWithScores(key, 0, -1);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 生成 Redis Key</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     * @param umId    用户ID</span></span>
<span class="line"><span>     * @param groupId 群聊ID</span></span>
<span class="line"><span>     * @return 生成的 Key</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    private String generateKey(String umId, String groupId) {</span></span>
<span class="line"><span>        return umId + &quot;-&quot; + groupId;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    public static void main(String[] args) {</span></span>
<span class="line"><span>        // 在 Spring 环境中，SessionManager 会被自动注入</span></span>
<span class="line"><span>        // 以下是模拟调用</span></span>
<span class="line"><span>        SessionManager sessionManager = new SessionManager();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // 模拟用户与智能体的对话</span></span>
<span class="line"><span>        String umId = &quot;user123&quot;;</span></span>
<span class="line"><span>        String groupId = &quot;group456&quot;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // 获取历史消息</span></span>
<span class="line"><span>        List&lt;JSONObject&gt; history = sessionManager.getHistory(umId, groupId);</span></span>
<span class="line"><span>        System.out.println(&quot;历史消息: &quot; + history);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // 模拟新对话</span></span>
<span class="line"><span>        List&lt;JSONObject&gt; newMessages = new ArrayList&lt;&gt;();</span></span>
<span class="line"><span>        newMessages.add(new JSONObject().fluentPut(&quot;role&quot;, &quot;user&quot;).fluentPut(&quot;content&quot;, &quot;你好！&quot;));</span></span>
<span class="line"><span>        newMessages.add(new JSONObject().fluentPut(&quot;role&quot;, &quot;assistant&quot;).fluentPut(&quot;content&quot;, &quot;你好，有什么可以帮您？&quot;));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // 保存新对话到历史消息</span></span>
<span class="line"><span>        sessionManager.saveHistory(umId, groupId, newMessages);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h2 id="实现2-0-lua脚本-异步保存-删除消息" tabindex="-1">实现2.0: lua脚本+异步保存/删除消息 <a class="header-anchor" href="#实现2-0-lua脚本-异步保存-删除消息" aria-label="Permalink to &quot;实现2.0: lua脚本+异步保存/删除消息&quot;">​</a></h2><p>高并发情况下, 方案一可能有性能问题:</p><ul><li>频繁计算消息总字符数, 时间复杂度为O(n)</li><li>事务锁竞争</li><li>频繁删除消息</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>  import org.springframework.data.redis.core.RedisTemplate;</span></span>
<span class="line"><span>  import org.springframework.data.redis.core.ZSetOperations;</span></span>
<span class="line"><span>  import org.springframework.stereotype.Component;</span></span>
<span class="line"><span>  import com.alibaba.fastjson.JSON;</span></span>
<span class="line"><span>  import com.alibaba.fastjson.JSONObject;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  import javax.annotation.Resource;</span></span>
<span class="line"><span>  import java.util.ArrayList;</span></span>
<span class="line"><span>  import java.util.List;</span></span>
<span class="line"><span>  import java.util.Set;</span></span>
<span class="line"><span>  import java.util.concurrent.ExecutorService;</span></span>
<span class="line"><span>  import java.util.concurrent.Executors;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  @Component</span></span>
<span class="line"><span>  public class SessionManager {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      private static final int MAX_HISTORY_LENGTH = 10000; // 历史消息最大长度（字符数）</span></span>
<span class="line"><span>      private static final int HISTORY_EXPIRE_DAYS = 7; // 历史消息有效期（天）</span></span>
<span class="line"><span>      private static final long HISTORY_EXPIRE_SECONDS = HISTORY_EXPIRE_DAYS * 24 * 60 * 60; // 转换为秒</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      @Resource</span></span>
<span class="line"><span>      private RedisTemplate&lt;String, String&gt; redisTemplate; // RedisTemplate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      private final ExecutorService executorService = Executors.newFixedThreadPool(4); // 异步任务线程池</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      /**</span></span>
<span class="line"><span>       * 获取历史消息</span></span>
<span class="line"><span>       *</span></span>
<span class="line"><span>       * @param umId    用户ID</span></span>
<span class="line"><span>       * @param groupId 群聊ID</span></span>
<span class="line"><span>       * @return 历史消息列表</span></span>
<span class="line"><span>       */</span></span>
<span class="line"><span>      public List&lt;JSONObject&gt; getHistory(String umId, String groupId) {</span></span>
<span class="line"><span>          String key = generateKey(umId, groupId);</span></span>
<span class="line"><span>          // 获取最近7天的消息</span></span>
<span class="line"><span>          long minScore = System.currentTimeMillis() / 1000 - HISTORY_EXPIRE_SECONDS;</span></span>
<span class="line"><span>          Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; messages = redisTemplate.opsForZSet().rangeByScoreWithScores(key, minScore, Double.POSITIVE_INFINITY);</span></span>
<span class="line"><span>          List&lt;JSONObject&gt; history = new ArrayList&lt;&gt;();</span></span>
<span class="line"><span>          if (messages != null) {</span></span>
<span class="line"><span>              for (ZSetOperations.TypedTuple&lt;String&gt; message : messages) {</span></span>
<span class="line"><span>                  history.add(JSON.parseObject(message.getValue()));</span></span>
<span class="line"><span>              }</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>          return history;</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      /**</span></span>
<span class="line"><span>       * 保存当前对话到历史消息</span></span>
<span class="line"><span>       *</span></span>
<span class="line"><span>       * @param umId     用户ID</span></span>
<span class="line"><span>       * @param groupId  群聊ID</span></span>
<span class="line"><span>       * @param messages 当前对话消息列表</span></span>
<span class="line"><span>       */</span></span>
<span class="line"><span>      public void saveHistory(String umId, String groupId, List&lt;JSONObject&gt; messages) {</span></span>
<span class="line"><span>          String key = generateKey(umId, groupId);</span></span>
<span class="line"><span>          // 异步保存消息</span></span>
<span class="line"><span>          executorService.submit(() -&gt; {</span></span>
<span class="line"><span>              // 添加新消息</span></span>
<span class="line"><span>              long currentTime = System.currentTimeMillis() / 1000;</span></span>
<span class="line"><span>              for (JSONObject message : messages) {</span></span>
<span class="line"><span>                  redisTemplate.opsForZSet().add(key, message.toJSONString(), currentTime);</span></span>
<span class="line"><span>              }</span></span>
<span class="line"><span>              // 删除7天前的消息</span></span>
<span class="line"><span>              long minScore = currentTime - HISTORY_EXPIRE_SECONDS;</span></span>
<span class="line"><span>              redisTemplate.opsForZSet().removeRangeByScore(key, 0, minScore);</span></span>
<span class="line"><span>              // 检查历史消息总字符数，超出则移除最早的消息</span></span>
<span class="line"><span>              trimHistoryByLength(key);</span></span>
<span class="line"><span>          });</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      /**</span></span>
<span class="line"><span>       * 根据消息总字符数修剪历史消息</span></span>
<span class="line"><span>       *</span></span>
<span class="line"><span>       * @param key Redis Key</span></span>
<span class="line"><span>       */</span></span>
<span class="line"><span>      private void trimHistoryByLength(String key) {</span></span>
<span class="line"><span>          // 使用 Lua 脚本计算总字符数并删除多余消息</span></span>
<span class="line"><span>          String luaScript =</span></span>
<span class="line"><span>              &quot;local key = KEYS[1]\n&quot; +</span></span>
<span class="line"><span>              &quot;local maxLength = tonumber(ARGV[1])\n&quot; +</span></span>
<span class="line"><span>              &quot;local messages = redis.call(&#39;zrange&#39;, key, 0, -1, &#39;WITHSCORES&#39;)\n&quot; +</span></span>
<span class="line"><span>              &quot;local totalLength = 0\n&quot; +</span></span>
<span class="line"><span>              &quot;local removeCount = 0\n&quot; +</span></span>
<span class="line"><span>              &quot;for i = 1, #messages, 2 do\n&quot; +</span></span>
<span class="line"><span>              &quot;    totalLength = totalLength + string.len(messages[i])\n&quot; +</span></span>
<span class="line"><span>              &quot;    if totalLength &gt; maxLength then\n&quot; +</span></span>
<span class="line"><span>              &quot;        removeCount = removeCount + 1\n&quot; +</span></span>
<span class="line"><span>              &quot;    end\n&quot; +</span></span>
<span class="line"><span>              &quot;end\n&quot; +</span></span>
<span class="line"><span>              &quot;if removeCount &gt; 0 then\n&quot; +</span></span>
<span class="line"><span>              &quot;    redis.call(&#39;zremrangebyrank&#39;, key, 0, removeCount - 1)\n&quot; +</span></span>
<span class="line"><span>              &quot;end\n&quot; +</span></span>
<span class="line"><span>              &quot;return removeCount&quot;;</span></span>
<span class="line"><span>          redisTemplate.execute(new DefaultRedisScript&lt;&gt;(luaScript, Long.class), List.of(key), String.valueOf(MAX_HISTORY_LENGTH));</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      /**</span></span>
<span class="line"><span>       * 生成 Redis Key</span></span>
<span class="line"><span>       *</span></span>
<span class="line"><span>       * @param umId    用户ID</span></span>
<span class="line"><span>       * @param groupId 群聊ID</span></span>
<span class="line"><span>       * @return 生成的 Key</span></span>
<span class="line"><span>       */</span></span>
<span class="line"><span>      private String generateKey(String umId, String groupId) {</span></span>
<span class="line"><span>          return umId + &quot;-&quot; + groupId;</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      public static void main(String[] args) {</span></span>
<span class="line"><span>          // 在 Spring 环境中，SessionManager 会被自动注入</span></span>
<span class="line"><span>          // 以下是模拟调用</span></span>
<span class="line"><span>          SessionManager sessionManager = new SessionManager();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>          // 模拟用户与智能体的对话</span></span>
<span class="line"><span>          String umId = &quot;user123&quot;;</span></span>
<span class="line"><span>          String groupId = &quot;group456&quot;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>          // 获取历史消息</span></span>
<span class="line"><span>          List&lt;JSONObject&gt; history = sessionManager.getHistory(umId, groupId);</span></span>
<span class="line"><span>          System.out.println(&quot;历史消息: &quot; + history);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>          // 模拟新对话</span></span>
<span class="line"><span>          List&lt;JSONObject&gt; newMessages = new ArrayList&lt;&gt;();</span></span>
<span class="line"><span>          newMessages.add(new JSONObject().fluentPut(&quot;role&quot;, &quot;user&quot;).fluentPut(&quot;content&quot;, &quot;你好！&quot;));</span></span>
<span class="line"><span>          newMessages.add(new JSONObject().fluentPut(&quot;role&quot;, &quot;assistant&quot;).fluentPut(&quot;content&quot;, &quot;你好，有什么可以帮您？&quot;));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>          // 保存新对话到历史消息</span></span>
<span class="line"><span>          sessionManager.saveHistory(umId, groupId, newMessages);</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>  }</span></span></code></pre></div><h2 id="实现3-0-分层设计" tabindex="-1">实现3.0: 分层设计 <a class="header-anchor" href="#实现3-0-分层设计" aria-label="Permalink to &quot;实现3.0: 分层设计&quot;">​</a></h2><p>在 Session 上设计字符总长度限制是为了满足大模型的 Token 长度限制，避免因输入过长导致大模型无响应。这是一个合理的需求，但直接在 Session 层实现字符总长度限制可能会带来性能问题 将字符长度限制的逻辑从 Session 层剥离，放到更靠近大模型调用的地方（如大模型服务层）。这样可以减少 Session 层的复杂度，同时提高性能</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>import org.springframework.data.redis.core.RedisTemplate;</span></span>
<span class="line"><span>import org.springframework.data.redis.core.ZSetOperations;</span></span>
<span class="line"><span>import org.springframework.stereotype.Component;</span></span>
<span class="line"><span>import com.alibaba.fastjson.JSON;</span></span>
<span class="line"><span>import com.alibaba.fastjson.JSONObject;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import javax.annotation.Resource;</span></span>
<span class="line"><span>import java.util.ArrayList;</span></span>
<span class="line"><span>import java.util.List;</span></span>
<span class="line"><span>import java.util.Set;</span></span>
<span class="line"><span>import java.util.concurrent.ExecutorService;</span></span>
<span class="line"><span>import java.util.concurrent.Executors;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@Component</span></span>
<span class="line"><span>public class SessionManager {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    private static final int HISTORY_EXPIRE_DAYS = 7; // 历史消息有效期（天）</span></span>
<span class="line"><span>    private static final long HISTORY_EXPIRE_SECONDS = HISTORY_EXPIRE_DAYS * 24 * 60 * 60; // 转换为秒</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Resource</span></span>
<span class="line"><span>    private RedisTemplate&lt;String, String&gt; redisTemplate; // RedisTemplate</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    private final ExecutorService executorService = Executors.newFixedThreadPool(4); // 异步任务线程池</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 获取历史消息</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     * @param umId    用户ID</span></span>
<span class="line"><span>     * @param groupId 群聊ID</span></span>
<span class="line"><span>     * @return 历史消息列表</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    public List&lt;JSONObject&gt; getHistory(String umId, String groupId) {</span></span>
<span class="line"><span>        String key = generateKey(umId, groupId);</span></span>
<span class="line"><span>        // 获取最近7天的消息</span></span>
<span class="line"><span>        long minScore = System.currentTimeMillis() / 1000 - HISTORY_EXPIRE_SECONDS;</span></span>
<span class="line"><span>        Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; messages = redisTemplate.opsForZSet().rangeByScoreWithScores(key, minScore, Double.POSITIVE_INFINITY);</span></span>
<span class="line"><span>        List&lt;JSONObject&gt; history = new ArrayList&lt;&gt;();</span></span>
<span class="line"><span>        if (messages != null) {</span></span>
<span class="line"><span>            for (ZSetOperations.TypedTuple&lt;String&gt; message : messages) {</span></span>
<span class="line"><span>                history.add(JSON.parseObject(message.getValue()));</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        return history;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 保存当前对话到历史消息</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     * @param umId     用户ID</span></span>
<span class="line"><span>     * @param groupId  群聊ID</span></span>
<span class="line"><span>     * @param messages 当前对话消息列表</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    public void saveHistory(String umId, String groupId, List&lt;JSONObject&gt; messages) {</span></span>
<span class="line"><span>        String key = generateKey(umId, groupId);</span></span>
<span class="line"><span>        // 异步保存消息</span></span>
<span class="line"><span>        executorService.submit(() -&gt; {</span></span>
<span class="line"><span>            // 添加新消息</span></span>
<span class="line"><span>            long currentTime = System.currentTimeMillis() / 1000;</span></span>
<span class="line"><span>            for (JSONObject message : messages) {</span></span>
<span class="line"><span>                redisTemplate.opsForZSet().add(key, message.toJSONString(), currentTime);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            // 删除7天前的消息</span></span>
<span class="line"><span>            long minScore = currentTime - HISTORY_EXPIRE_SECONDS;</span></span>
<span class="line"><span>            redisTemplate.opsForZSet().removeRangeByScore(key, 0, minScore);</span></span>
<span class="line"><span>        });</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 生成 Redis Key</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     * @param umId    用户ID</span></span>
<span class="line"><span>     * @param groupId 群聊ID</span></span>
<span class="line"><span>     * @return 生成的 Key</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    private String generateKey(String umId, String groupId) {</span></span>
<span class="line"><span>        return umId + &quot;-&quot; + groupId;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>import org.springframework.stereotype.Component;</span></span>
<span class="line"><span>import com.alibaba.fastjson.JSONObject;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import javax.annotation.Resource;</span></span>
<span class="line"><span>import java.util.List;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>@Component</span></span>
<span class="line"><span>public class ModelService {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    private static final int MAX_TOKEN_LENGTH = 10000; // 大模型的 Token 长度限制</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Resource</span></span>
<span class="line"><span>    private SessionManager sessionManager;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 调用大模型</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     * @param umId    用户ID</span></span>
<span class="line"><span>     * @param groupId 群聊ID</span></span>
<span class="line"><span>     * @param message 用户输入的消息</span></span>
<span class="line"><span>     * @return 大模型的响应</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    public String callModel(String umId, String groupId, JSONObject message) {</span></span>
<span class="line"><span>        // 获取历史消息</span></span>
<span class="line"><span>        List&lt;JSONObject&gt; history = sessionManager.getHistory(umId, groupId);</span></span>
<span class="line"><span>        // 动态截断历史消息，确保输入不超过 Token 限制</span></span>
<span class="line"><span>        List&lt;JSONObject&gt; truncatedHistory = truncateHistory(history);</span></span>
<span class="line"><span>        // 调用大模型</span></span>
<span class="line"><span>        return callModelInternal(truncatedHistory, message);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 动态截断历史消息</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     * @param history 完整的历史消息</span></span>
<span class="line"><span>     * @return 截断后的历史消息</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    private List&lt;JSONObject&gt; truncateHistory(List&lt;JSONObject&gt; history) {</span></span>
<span class="line"><span>        int totalLength = 0;</span></span>
<span class="line"><span>        List&lt;JSONObject&gt; truncatedHistory = new ArrayList&lt;&gt;();</span></span>
<span class="line"><span>        for (JSONObject message : history) {</span></span>
<span class="line"><span>            int messageLength = calculateTokenLength(message);</span></span>
<span class="line"><span>            if (totalLength + messageLength &gt; MAX_TOKEN_LENGTH) {</span></span>
<span class="line"><span>                break;</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            truncatedHistory.add(message);</span></span>
<span class="line"><span>            totalLength += messageLength;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        return truncatedHistory;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 计算消息的 Token 长度</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     * @param message 消息</span></span>
<span class="line"><span>     * @return Token 长度</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    private int calculateTokenLength(JSONObject message) {</span></span>
<span class="line"><span>        // 这里可以根据实际需求实现 Token 计算逻辑</span></span>
<span class="line"><span>        return message.toJSONString().length(); // 简单实现：使用字符数代替 Token 数</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 调用大模型的内部方法</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     * @param history 历史消息</span></span>
<span class="line"><span>     * @param message 用户输入的消息</span></span>
<span class="line"><span>     * @return 大模型的响应</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    private String callModelInternal(List&lt;JSONObject&gt; history, JSONObject message) {</span></span>
<span class="line"><span>        // 这里实现调用大模型的逻辑</span></span>
<span class="line"><span>        return &quot;大模型响应&quot;;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h2 id="最后落地方案" tabindex="-1">最后落地方案 <a class="header-anchor" href="#最后落地方案" aria-label="Permalink to &quot;最后落地方案&quot;">​</a></h2><ol><li>session只管存取历史消息</li><li>调大模型agent时会根据token限制截取消息</li><li>新建个定时任务每天清理超过7天的消息, 以及超过了token限制的消息</li></ol><h2 id="补充" tabindex="-1">补充 <a class="header-anchor" href="#补充" aria-label="Permalink to &quot;补充&quot;">​</a></h2><ol><li>Redis的Zset超过10w个元素, 可能触发性能问题（删除/遍历耗时 &gt;1秒）, 由于智能体7天内聊天轮数约3*7&lt;&lt;10w, 无风险</li><li>单个元素 &gt;10KB：Redis 内部内存管理会将其视为“大对象”（Large Object）频繁分配/释放大对象可能导致内存碎片, 在支持RAG后, 用户历史消息极可能累计&gt;1w字符, 简单算10k, 存在bigkey的风险</li><li>考虑到llm场景流式输出, 用户对时延不敏感, 后续可以考虑使用DB来存储历史消息</li></ol><p>删除BigKey的潜在风险:</p><ul><li>耗时较长, 高并发下可能阻塞其他请求</li><li>大规模删除可能导致主从同步延迟</li><li>产生内存碎片, 影响后续分配效率</li></ul></div></div></main><footer class="VPDocFooter" data-v-83890dd9 data-v-4f9813fa><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-4f9813fa><span class="visually-hidden" id="doc-footer-aria-label" data-v-4f9813fa>Pager</span><div class="pager" data-v-4f9813fa><a class="VPLink link pager-link prev" href="/blog/04-%E7%BC%93%E5%AD%98%E4%B8%8E%E4%B8%AD%E9%97%B4%E4%BB%B6/0402-RocketMQ/040201-RockectMQ%E5%9F%BA%E7%A1%80.html" data-v-4f9813fa><!--[--><span class="desc" data-v-4f9813fa>Previous page</span><span class="title" data-v-4f9813fa>RockectMQ基础</span><!--]--></a></div><div class="pager" data-v-4f9813fa><a class="VPLink link pager-link next" href="/blog/05-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/0501-%E5%BE%AE%E6%9C%8D%E5%8A%A1/050101-RateLimiter.html" data-v-4f9813fa><!--[--><span class="desc" data-v-4f9813fa>Next page</span><span class="title" data-v-4f9813fa>RateLimiter</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-a9a9e638 data-v-c970a860><div class="container" data-v-c970a860><p class="message" data-v-c970a860>Released under the MIT License.</p><p class="copyright" data-v-c970a860>Copyright © 2019-present Evan You</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"02-java语言基础_0201-java核心知识点_020101-java语言基础.md\":\"DX4yyIBq\",\"02-java语言基础_0201-java核心知识点_020102-io模型.md\":\"BR1aQ7BG\",\"02-java语言基础_0201-java核心知识点_020103-集合.md\":\"Dvt35pMT\",\"02-java语言基础_0203-jvm_020301-jvm基础.md\":\"DtWEcOhq\",\"03-数据库与持久化_0301-关系型数据库_030101-powerdesign简易教程.md\":\"CVbyXfi_\",\"03-数据库与持久化_0301-关系型数据库_030102-索引.md\":\"Dhsemn7w\",\"03-数据库与持久化_0301-关系型数据库_030103-mysql基础.md\":\"D7E4kHl8\",\"04-缓存与中间件_0401-rabbitmq_040101-rabbitmq基础(一).md\":\"Bqtghlcz\",\"04-缓存与中间件_0401-rabbitmq_040102-rabbitmq基础(二).md\":\"Ka-6gcBG\",\"04-缓存与中间件_0401-rabbitmq_040103-rabbitmq实践.md\":\"B0-ZqP4N\",\"04-缓存与中间件_0402-rocketmq_040201-rockectmq基础.md\":\"TK-Owcls\",\"04-缓存与中间件_0403-redis_040301-_案例_智能体session设计.md\":\"B8Xd3FbF\",\"05-微服务与分布式系统_0501-微服务_050101-ratelimiter.md\":\"B1oTkEHK\",\"05-微服务与分布式系统_0501-微服务_050102-filter_interceptor_aspect使用场景.md\":\"Cpu-bFxa\",\"05-微服务与分布式系统_0502-分布式_050201-分布式理论.md\":\"BFldXsD-\",\"05-微服务与分布式系统_0502-分布式_050202-服务注册与发现.md\":\"Bs-NoGjx\",\"05-微服务与分布式系统_0502-分布式_050203-客户端负载均衡.md\":\"UX-PV-D5\",\"05-微服务与分布式系统_0502-分布式_050204-服务容错保护.md\":\"BHql5QgG\",\"05-微服务与分布式系统_0502-分布式_050205-声明式服务调用.md\":\"BVOKTuJR\",\"05-微服务与分布式系统_0502-分布式_050206-api网关服务.md\":\"ChSdfDY2\",\"05-微服务与分布式系统_0502-分布式_050207-分布式配置中心.md\":\"-iNIlpij\",\"05-微服务与分布式系统_0502-分布式_050208-分布式链路追踪.md\":\"BJQfkpNG\",\"05-微服务与分布式系统_0502-分布式_050209-阿里微服务治理技术白皮书.md\":\"M_zau8vF\",\"06-架构设计与开发规范_0601-设计模式_060101-面向对象与设计原则.md\":\"BDYs2s-i\",\"06-架构设计与开发规范_0601-设计模式_060102-规范与重构.md\":\"CJQJKBiF\",\"06-架构设计与开发规范_0601-设计模式_060103-设计模式-创建型.md\":\"RDODF5Q4\",\"06-架构设计与开发规范_0601-设计模式_060104-设计模式-结构型.md\":\"6vsRGvMA\",\"06-架构设计与开发规范_0601-设计模式_060105-设计模式-行为型(上).md\":\"DcHlJHzZ\",\"06-架构设计与开发规范_0601-设计模式_060106-设计模式-行为型(下).md\":\"BtirqnMS\",\"06-架构设计与开发规范_0603-业务建模_060301-业务建模基础.md\":\"BOO4gA5f\",\"08-前沿技术与扩展领域_0801-人工智能_080101-gpt原理.md\":\"BHErv0TG\",\"08-前沿技术与扩展领域_0801-人工智能_080102-rag优化.md\":\"Zf7CSEm_\",\"09-实战与问题排查_0901-微服务配置热刷后无法处理请求问题.md\":\"C2J5Qom1\",\"09-实战与问题排查_0902-信长博客站搭建.md\":\"BaSFgEY1\",\"10-其他_参考资料.md\":\"DVMtgKwN\",\"10-其他_里程碑.md\":\"DlDNxpF9\",\"11-杂学_1101-羽毛球练习心得.md\":\"DJ5CNvd6\",\"11-杂学_1102-芯片.md\":\"DzcrzCzg\",\"11-杂学_1103-信长厨房.md\":\"DuvRCzN1\",\"11-杂学_1104-信长的至理名言.md\":\"DO2ITQaf\",\"index.md\":\"CjfEMndB\",\"介绍.md\":\"aptPk51W\",\"关于我.md\":\"BURXBs_2\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"信长笔记2.0\",\"description\":\"信长笔记2.0\",\"base\":\"/blog/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/avatar.jpg\",\"search\":{\"provider\":\"local\"},\"nav\":[{\"text\":\"首页\",\"link\":\"/\"},{\"text\":\"关于我\",\"link\":\"/关于我\"}],\"sidebar\":[{\"text\":\"计算机基础\",\"items\":[]},{\"text\":\"Java语言基础\",\"items\":[{\"text\":\"Java核心知识点\",\"collapsed\":true,\"items\":[{\"text\":\"Java语言基础\",\"link\":\"/02-Java语言基础/0201-Java核心知识点/020101-Java语言基础\"},{\"text\":\"IO模型\",\"link\":\"/02-Java语言基础/0201-Java核心知识点/020102-IO模型\"},{\"text\":\"集合\",\"link\":\"/02-Java语言基础/0201-Java核心知识点/020103-集合\"}]},{\"text\":\"JVM\",\"collapsed\":true,\"items\":[{\"text\":\"JVM基础\",\"link\":\"/02-Java语言基础/0203-JVM/020301-JVM基础\"}]}]},{\"text\":\"数据库与持久化\",\"items\":[{\"text\":\"关系型数据库\",\"collapsed\":true,\"items\":[{\"text\":\"PowerDesign简易教程\",\"link\":\"/03-数据库与持久化/0301-关系型数据库/030101-PowerDesign简易教程\"},{\"text\":\"索引\",\"link\":\"/03-数据库与持久化/0301-关系型数据库/030102-索引\"},{\"text\":\"MySQL基础\",\"link\":\"/03-数据库与持久化/0301-关系型数据库/030103-MySQL基础\"}]}]},{\"text\":\"缓存与中间件\",\"items\":[{\"text\":\"RabbitMQ\",\"collapsed\":true,\"items\":[{\"text\":\"RabbitMQ基础(一)\",\"link\":\"/04-缓存与中间件/0401-RabbitMQ/040101-RabbitMQ基础(一)\"},{\"text\":\"RabbitMQ基础(二)\",\"link\":\"/04-缓存与中间件/0401-RabbitMQ/040102-RabbitMQ基础(二)\"},{\"text\":\"RabbitMQ实践\",\"link\":\"/04-缓存与中间件/0401-RabbitMQ/040103-RabbitMQ实践\"}]},{\"text\":\"RocketMQ\",\"collapsed\":true,\"items\":[{\"text\":\"RockectMQ基础\",\"link\":\"/04-缓存与中间件/0402-RocketMQ/040201-RockectMQ基础\"}]},{\"text\":\"Redis\",\"collapsed\":true,\"items\":[{\"text\":\"[案例]智能体session设计\",\"link\":\"/04-缓存与中间件/0403-Redis/040301-[案例]智能体session设计\"}]}]},{\"text\":\"微服务与分布式系统\",\"items\":[{\"text\":\"微服务\",\"collapsed\":true,\"items\":[{\"text\":\"RateLimiter\",\"link\":\"/05-微服务与分布式系统/0501-微服务/050101-RateLimiter\"},{\"text\":\"Filter&Interceptor&Aspect使用场景\",\"link\":\"/05-微服务与分布式系统/0501-微服务/050102-Filter&Interceptor&Aspect使用场景\"}]},{\"text\":\"分布式\",\"collapsed\":true,\"items\":[{\"text\":\"分布式理论\",\"link\":\"/05-微服务与分布式系统/0502-分布式/050201-分布式理论\"},{\"text\":\"服务注册与发现\",\"link\":\"/05-微服务与分布式系统/0502-分布式/050202-服务注册与发现\"},{\"text\":\"客户端负载均衡\",\"link\":\"/05-微服务与分布式系统/0502-分布式/050203-客户端负载均衡\"},{\"text\":\"服务容错保护\",\"link\":\"/05-微服务与分布式系统/0502-分布式/050204-服务容错保护\"},{\"text\":\"声明式服务调用\",\"link\":\"/05-微服务与分布式系统/0502-分布式/050205-声明式服务调用\"},{\"text\":\"API网关服务\",\"link\":\"/05-微服务与分布式系统/0502-分布式/050206-API网关服务\"},{\"text\":\"分布式配置中心\",\"link\":\"/05-微服务与分布式系统/0502-分布式/050207-分布式配置中心\"},{\"text\":\"分布式链路追踪\",\"link\":\"/05-微服务与分布式系统/0502-分布式/050208-分布式链路追踪\"},{\"text\":\"阿里微服务治理技术白皮书\",\"link\":\"/05-微服务与分布式系统/0502-分布式/050209-阿里微服务治理技术白皮书\"}]}]},{\"text\":\"架构设计与开发规范\",\"items\":[{\"text\":\"设计模式\",\"collapsed\":true,\"items\":[{\"text\":\"面向对象与设计原则\",\"link\":\"/06-架构设计与开发规范/0601-设计模式/060101-面向对象与设计原则\"},{\"text\":\"规范与重构\",\"link\":\"/06-架构设计与开发规范/0601-设计模式/060102-规范与重构\"},{\"text\":\"设计模式-创建型\",\"link\":\"/06-架构设计与开发规范/0601-设计模式/060103-设计模式-创建型\"},{\"text\":\"设计模式-结构型\",\"link\":\"/06-架构设计与开发规范/0601-设计模式/060104-设计模式-结构型\"},{\"text\":\"设计模式-行为型(上)\",\"link\":\"/06-架构设计与开发规范/0601-设计模式/060105-设计模式-行为型(上)\"},{\"text\":\"设计模式-行为型(下)\",\"link\":\"/06-架构设计与开发规范/0601-设计模式/060106-设计模式-行为型(下)\"}]},{\"text\":\"业务建模\",\"collapsed\":true,\"items\":[{\"text\":\"业务建模基础\",\"link\":\"/06-架构设计与开发规范/0603-业务建模/060301-业务建模基础\"}]}]},{\"text\":\"开发工具与DevOps\",\"items\":[]},{\"text\":\"前沿技术与扩展领域\",\"items\":[{\"text\":\"人工智能\",\"collapsed\":true,\"items\":[{\"text\":\"GPT原理\",\"link\":\"/08-前沿技术与扩展领域/0801-人工智能/080101-GPT原理\"},{\"text\":\"RAG优化\",\"link\":\"/08-前沿技术与扩展领域/0801-人工智能/080102-RAG优化\"}]}]},{\"text\":\"实战与问题排查\",\"items\":[{\"text\":\"微服务配置热刷后无法处理请求问题\",\"link\":\"/09-实战与问题排查/0901-微服务配置热刷后无法处理请求问题\"},{\"text\":\"信长博客站搭建\",\"link\":\"/09-实战与问题排查/0902-信长博客站搭建\"}]},{\"text\":\"其他\",\"items\":[{\"text\":\"\",\"link\":\"/10-其他/参考资料\"},{\"text\":\"\",\"link\":\"/10-其他/里程碑\"}]},{\"text\":\"杂学\",\"items\":[{\"text\":\"羽毛球练习心得\",\"link\":\"/11-杂学/1101-羽毛球练习心得\"},{\"text\":\"芯片\",\"link\":\"/11-杂学/1102-芯片\"},{\"text\":\"信长厨房\",\"link\":\"/11-杂学/1103-信长厨房\"},{\"text\":\"信长的至理名言\",\"link\":\"/11-杂学/1104-信长的至理名言\"}]},{\"text\":\"\",\"items\":[]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/vuejs/vitepress\"}],\"footer\":{\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2019-present Evan You\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>